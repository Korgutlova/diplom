{% extends 'fls/base_template.html' %}
{% load widget_tweaks %}
{% block title %}Создание конкурса. 1 Этап {% endblock %}
{% block content %}
    <h3>Создание конкурса. 1 Этап</h3>
    <hr>
    <div class="row">
        <div class="col-xs-4">
            <form id="form">
                {% csrf_token %}
                <div style="width: 300px">
                    {% for field in form %}
                        <div class="form-group{% if field.errors %} has-error{% endif %}">
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {% render_field field class="form-control" %}
                            {% for error in field.errors %}
                                <p class="help-block">{{ error }}</p>
                            {% endfor %}
                        </div>
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <p class="help-block">{{ error }}</p>
                    {% endfor %}
                </div>
            </form>
            <button id="submit" class="btn btn-primary labelText">
                <span>Сохранить и перейти к следующему этапу</span>
            </button>
        </div>
        <div class="col-xs-8">
            <h3>Создание выпадающих списков</h3>
            <div class="enum" id="enum_1">
                <div class="col-xs-12">
                    <hr>
                    <h4>Список </h4>
                    <a href="#" class="close delete_param" style="color: red;font-size: 34px;" aria-label="Close"
                       role="button">&times;</a>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Название
                                <input class="form-control" type="text" name="text">
                            </label><br>
                        </div>
                    </div>
                    <hr>
                </div>
                <div class="col-xs-12">
                    <h5>Варианты выбора списка</h5>
                    <a href="#" style="color: #1e7e34;font-size: 24px">
                        <span class="glyphicon glyphicon-plus add_subparam"></span>
                    </a>
                </div>
                <div class="subparam" id="subparam_1">
                    <a href="#" class="close delete_subparam" style="color: red;font-size: 34px;" aria-label="Close"
                       role="button">&times;</a>
                    <div class="form-row">
                        <div class="form-group col-md-5">
                            <label>Ключ - название
                                <input class="form-control" type="text" id="enum_text">
                            </label>
                        </div>
                        <div class="form-group col-md-5">
                            <label>Значение - число
                                <input class="form-control" type="number" step="0.001" id="enum_value">
                            </label>
                        </div>
                        <br>
                        <br>
                    </div>
                </div>
            </div>
            <br>
            <div class="col-xs-12">
                <a href="#" class="btn btn-info add_enum" role="button"><span>Добавить список</span></a>
            </div>
            <br>
            <br>
        </div>
    </div>

{% endblock %}
{% block script %}
    <script>
        $(document).ready(function () {
            $.fn.scrollView = function () {
                return this.each(function () {
                    $('html, body').animate({
                        scrollTop: $(this).offset().top
                    }, 1000);
                });
            };

            $(".add_enum").click(function () {
                var lastid = $(".enum:last").attr("id");
                var nextindex = Number(lastid.split('_')[1]) + 1;
                $(".enum:last").after("<div class=\"enum\" id=\"enum_" + nextindex + "\"></div>");
                $("#enum_" + nextindex).append("<div class=\"col-xs-12\">\n" +
                    "                    <hr>\n" +
                    "                    <h4>Список </h4>\n" +
                    "                    <a href=\"#\" class=\"close delete_param\" style=\"color: red;font-size: 34px;\" aria-label=\"Close\"\n" +
                    "                       role=\"button\">&times;</a>\n" +
                    "                    <div class=\"form-row\">\n" +
                    "                        <div class=\"form-group\">\n" +
                    "                            <label>Название\n" +
                    "                                <input class=\"form-control\" type=\"text\" name=\"text\">\n" +
                    "                            </label><br>\n" +
                    "                        </div>\n" +
                    "                    </div>\n" +
                    "                    <hr>\n" +
                    "                </div>\n" +
                    "                <div class=\"col-xs-12\">\n" +
                    "                    <h5>Варианты выбора списка</h5>\n" +
                    "                    <a href=\"#\" style=\"color: #1e7e34;font-size: 24px\">\n" +
                    "                        <span class=\"glyphicon glyphicon-plus add_subparam\"></span>\n" +
                    "                    </a>\n" +
                    "                </div>");

                var lastid = $(".subparam:last").attr("id");
                var newindex = Number(lastid.split('_')[1]) + 1;
                $("#enum_" + nextindex + " .col-xs-12:last").after("<div class=\"subparam\" id=\"subparam_" + newindex + "\"></div>");
                $("#subparam_" + newindex).append("<a href=\"#\" class=\"close delete_subparam\" style=\"color: red;font-size: 34px;\" aria-label=\"Close\"\n" +
                    "                       role=\"button\">&times;</a>\n" +
                    "                    <div class=\"form-row\">\n" +
                    "                        <div class=\"form-group col-md-5\">\n" +
                    "                            <label>Ключ - название\n" +
                    "                                <input class=\"form-control\" type=\"text\" id=\"enum_text\">\n" +
                    "                            </label>\n" +
                    "                        </div>\n" +
                    "                        <div class=\"form-group col-md-5\">\n" +
                    "                            <label>Значение - число\n" +
                    "                                <input class=\"form-control\" type=\"number\" step=\"0.001\" id=\"enum_value\">\n" +
                    "                            </label>\n" +
                    "                        </div>\n" +
                    "                        <br>\n" +
                    "                        <br>\n" +
                    "                    </div>");
            });


            $('.container').on('click', '.add_subparam', function () {
                var lastid = $(".subparam").length;
                var id = "subparam_" + (lastid + 1);
                $("#" + $("#" + $(this).parent().parent().parent().attr("id") + " .subparam:last").attr("id")).after("<div class=\"subparam\" id=\"" + id + "\"></div>");
                $("#" + id).append("<a href=\"#\" class=\"close delete_subparam\" style=\"color: red;font-size: 34px;\" aria-label=\"Close\"\n" +
                    "                       role=\"button\">&times;</a>\n" +
                    "                    <div class=\"form-row\">\n" +
                    "                        <div class=\"form-group col-md-5\">\n" +
                    "                            <label>Ключ - название\n" +
                    "                                <input class=\"form-control\" type=\"text\" id=\"enum_text\">\n" +
                    "                            </label>\n" +
                    "                        </div>\n" +
                    "                        <div class=\"form-group col-md-5\">\n" +
                    "                            <label>Значение - число\n" +
                    "                                <input class=\"form-control\" type=\"number\" step=\"0.001\" id=\"enum_value\">\n" +
                    "                            </label>\n" +
                    "                        </div>\n" +
                    "                        <br>\n" +
                    "                        <br>\n" +
                    "                    </div>");

            });

            $('.container').on('click', '.delete_param', function () {
                var total_element = $(".enum").length;
                if (total_element !== 1) {
                    $(this).parent().remove();
                }
            });

            $('.container').on('click', '.delete_subparam', function () {
                var id = $(this).parent().parent().attr("id");
                var total_element = $("#" + id + " .subparam").length;
                if (total_element !== 1) {
                    $(this).parent().remove();
                }
            });

            $(".container").on('click', '#submit', function () {
                var data_params = [];
                var enums = $('.enum');
                for (i = 0; i < enums.length; i++) {
                    var subparams = $("#" + $(enums[i]).attr("id") + " .subparam");
                    var data_subparams = [];
                    for (j = 0; j < subparams.length; j++) {
                        data_subparams.push({
                            "text": $(subparams[j]).find("#enum_text").val(),
                            "value": $(subparams[j]).find("#enum_value").val(),
                        });
                    }
                    var cust_enum = {
                        "name": $(enums[i]).find("input").val(),
                        "subparams": data_subparams,
                    };
                    data_params.push(cust_enum);
                }
                var result = {"params": data_params};
                var jurys = [];
                var array = decodeURI($("#form").serialize()).split("&");
                for (i = 0; i < array.length; i++) {
                    var values = array[i].split("=");
                    result[values[0]] = values[1];
                    if (values[0] === "jurys") {
                        jurys.push(values[1]);
                    }
                }
                alert(jurys);
                result["jurys"] = jurys;
                alert(result["jurys"]);
                $.ajax({
                    type: "post",
                    url: "/fls/comp/first",
                    data: result,
                    success: function (response){
                        alert("Success");
                        alert(response);
                        window.location = "http://127.0.0.1:8000/fls/comp/second/" + response.comp_id;
                    }
                });
            });

        });
    </script>
{% endblock %}